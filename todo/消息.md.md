### 1. 为什么要使用消息队列

是这样的，公司原来的系统是一个单体的应用，就会涉及到很多耦合性的问题，比如客户在下单后，  会涉及到扣减对应商品库存以及邮件通知对应的销售员等功能，就会造成下单时间比较久，给客户体验较差，我们针对下单这一块进行了优化，将上面那几部分抽离出去，将这些内容放到消息队列中，并通过不同的业务topic来区分，具体是这样，我们目前 独立成3个项目，一个负责消息通知，**一个负责再将扣减库存以及其他涉及到数据更新的内容**，最后一个就是消息队列的项目， 再回到我们原来的系统，下单后，通过Grpc发送消息到消息队列的项目中，其他两个应用分别监听并消费对应的消息，这样使原来下单的部分内容异步处理，而且降低了下单的耦合性，下单速度有明显提升。                 



自己负责消息通知那个应用的全部开发，数据更新内容的应用部分开发                                                                                                                                                                                                                   ，Grpc搭建，前台监控页面

削峰，异步，解耦，

- 削峰

### 2. 使用消息队列可能会有哪些问题

重复消费(保证消息幂等性)，数据一致性，消息丢失

### 3. 如何解决这些问题

- 保持高可用

1. 普通集群   （只有一个消息队列节点内有消息数据，其他的节点只保存了有消息数据节点的元数据，每次消费的时候，会通过元数据找到对应的主节点，拿到消息（不能有效的保障高可用，多个消息队列间的数据传输也可能影响传输）
2. 镜像集群   （每一个消息队列节点 都保存有数据，当一条消息放入队列中，会同步给其他几个消息队列）

- 消息重复消费

1. 保证幂等性

- 消息保证可靠性，保证消息不丢失
  - 生产者发送消息丢失
    - 通过事务，在捕获的异常中回滚事务，并重试发送消息(问题： 事务时原子性的，在发送消息的时候会等待消息发送，成功后一整个事务才可以提交成功，)
    - 通过回调方法的机制，发送 消息后，发送成功或失败都会回调对应的方法
  - mq自己挂了
    - 持久化
  - 消费者自己处理时挂了，消息消费失败
    - 关闭消息队列的autoAck的机制，不让消费者自动发送消费完成的消息给消息队列，而是自己在消费端在执行结束后给消息队列发送消费完成的标志
- 消息保证顺序消费
  - 将多条消息顺序放到消息队列中的一个queue中，他们执行的时候就会按序执行
- 消息大量积压
  - 以kafka为例，新建一个topic，下面的partition数量时原来的10倍，服务器数量也是如此，临时将消费端修改代码，不把数据落到db中，而是发到新建的partition中，让他们来处理。
- 消息一致性
  - 可以和消息丢失类比，两者相似
- 如何设计一个消息队列
  - 保证扩展性
  - 可以持久化
  - 高可用行
  - 如何保证数据丢失问题，顺序消费问题。



